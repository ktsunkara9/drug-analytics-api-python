PS D:\coding\GIT_Work_Space\drug-analytics-api-python> pytest .\tests\test_drug_service.py -v      
========================================================== test session starts ===========================================================
platform win32 -- Python 3.12.7, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\ktsun\AppData\Local\Programs\Python\Python312\python.exe
cachedir: .pytest_cache
rootdir: D:\coding\GIT_Work_Space\drug-analytics-api-python
plugins: anyio-4.11.0, asyncio-1.2.0, cov-7.0.0
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 7 items                                                                                                                         

tests/test_drug_service.py::TestDrugService::test_upload_drug_data_success FAILED                                                   [ 14%]
tests/test_drug_service.py::TestDrugService::test_get_drug_by_name_success PASSED                                                   [ 28%]
tests/test_drug_service.py::TestDrugService::test_get_drug_by_name_multiple_versions PASSED                                         [ 42%]
tests/test_drug_service.py::TestDrugService::test_get_all_drugs_success PASSED                                                      [ 57%]
tests/test_drug_service.py::TestDrugService::test_get_all_drugs_empty PASSED                                                        [ 71%] 
tests/test_drug_service.py::TestDrugService::test_process_csv_and_save_success PASSED                                               [ 85%]
tests/test_drug_service.py::TestDrugService::test_process_csv_and_save_multiple_records PASSED                                      [100%] 

================================================================ FAILURES ================================================================ 
_____________________________________________ TestDrugService.test_upload_drug_data_success ______________________________________________ 

self = <src.repositories.upload_status_repository.UploadStatusRepository object at 0x00000169C8BA48F0>
upload_status = UploadStatus(upload_id=a69f36c0-4e90-42fb-9c77-0fe439cc41b0, status=pending, filename=test.csv)

    def create(self, upload_status: UploadStatus) -> None:
        """
        Create new upload status record.

        Args:
            upload_status: UploadStatus domain model

        Raises:
            DynamoDBException: If create operation fails
        """
        try:
            item = {
                'upload_id': upload_status.upload_id,
                'status': upload_status.status,
                'filename': upload_status.filename,
                's3_key': upload_status.s3_key,
                'created_at': upload_status.created_at.isoformat(),
                'total_rows': upload_status.total_rows,
                'processed_rows': upload_status.processed_rows
            }

            if upload_status.error_message:
                item['error_message'] = upload_status.error_message

>           self.table.put_item(Item=item)

src\repositories\upload_status_repository.py:45:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _  
C:\Users\ktsun\AppData\Local\Programs\Python\Python312\Lib\site-packages\boto3\resources\factory.py:581: in do_action
    response = action(self, *args, **kwargs)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ktsun\AppData\Local\Programs\Python\Python312\Lib\site-packages\boto3\resources\action.py:88: in __call__
    response = getattr(parent.meta.client, operation_name)(*args, **params)
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ktsun\AppData\Local\Programs\Python\Python312\Lib\site-packages\botocore\client.py:602: in _api_call
    return self._make_api_call(operation_name, kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
C:\Users\ktsun\AppData\Local\Programs\Python\Python312\Lib\site-packages\botocore\context.py:123: in wrapper
    return func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
C:\Users\ktsun\AppData\Local\Programs\Python\Python312\Lib\site-packages\botocore\client.py:1035: in _make_api_call
    request_dict = self._convert_to_request_dict(
C:\Users\ktsun\AppData\Local\Programs\Python\Python312\Lib\site-packages\botocore\client.py:1102: in _convert_to_request_dict
    request_dict = self._serializer.serialize_to_request(
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _  

self = <botocore.validate.ParamValidationDecorator object at 0x00000169CA505850>
parameters = {'Item': {'created_at': {'S': '2025-11-08T20:26:17.773193'}, 'filename': {'S': 'test.csv'}, 'processed_rows': {'N': '0'}, 's3_key': {'S': 'uploads/2024/01/01/abc123_test.csv'}, ...}, 'TableName': ''}
operation_model = OperationModel(name=PutItem)

    def serialize_to_request(self, parameters, operation_model):
        input_shape = operation_model.input_shape
        if input_shape is not None:
            report = self._param_validator.validate(
                parameters, operation_model.input_shape
            )
            if report.has_errors():
>               raise ParamValidationError(report=report.generate_report())
E               botocore.exceptions.ParamValidationError: Parameter validation failed:
E               Invalid length for parameter TableName, value: 0, valid min length: 1

C:\Users\ktsun\AppData\Local\Programs\Python\Python312\Lib\site-packages\botocore\validate.py:381: ParamValidationError

The above exception was the direct cause of the following exception:

self = <tests.test_drug_service.TestDrugService object at 0x00000169C798AC00>
drug_service = <src.services.drug_service.DrugService object at 0x00000169C8B0BA10>, mock_s3_repo = <Mock id='1553850845328'>
mock_file_service = <Mock id='1553832069312'>

    def test_upload_drug_data_success(self, drug_service, mock_s3_repo, mock_file_service):
        """Test successful drug data upload."""
        # Setup
        file = io.BytesIO(b"drug_name,target,efficacy\nAspirin,COX-2,85.5")
        filename = "test.csv"
        mock_file_service.validate_csv_structure.return_value = None
        mock_s3_repo.upload_file.return_value = {
            's3_key': 'uploads/2024/01/01/abc123_test.csv',
            's3_location': 's3://bucket/uploads/2024/01/01/abc123_test.csv'
        }

        # Execute
>       result = drug_service.upload_drug_data(file, filename)
                 ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

tests\test_drug_service.py:64:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _  
src\services\drug_service.py:65: in upload_drug_data
    self.upload_status_repository.create(upload_status)
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _  

self = <src.repositories.upload_status_repository.UploadStatusRepository object at 0x00000169C8BA48F0>
upload_status = UploadStatus(upload_id=a69f36c0-4e90-42fb-9c77-0fe439cc41b0, status=pending, filename=test.csv)

    def create(self, upload_status: UploadStatus) -> None:
        """
        Create new upload status record.

        Args:
            upload_status: UploadStatus domain model

        Raises:
            DynamoDBException: If create operation fails
        """
        try:
            item = {
                'upload_id': upload_status.upload_id,
                'status': upload_status.status,
                'filename': upload_status.filename,
                's3_key': upload_status.s3_key,
                'created_at': upload_status.created_at.isoformat(),
                'total_rows': upload_status.total_rows,
                'processed_rows': upload_status.processed_rows
            }

            if upload_status.error_message:
                item['error_message'] = upload_status.error_message

            self.table.put_item(Item=item)

        except ClientError as e:
            raise DynamoDBException(f"Failed to create upload status: {str(e)}") from e
        except Exception as e:
>           raise DynamoDBException(f"Unexpected error creating upload status: {str(e)}") from e
E           src.core.exceptions.DynamoDBException: Unexpected error creating upload status: Parameter validation failed:
E           Invalid length for parameter TableName, value: 0, valid min length: 1

src\repositories\upload_status_repository.py:50: DynamoDBException
============================================================ warnings summary ============================================================ 
src\models\dto\drug_dto.py:31
  D:\coding\GIT_Work_Space\drug-analytics-api-python\src\models\dto\drug_dto.py:31: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class DrugResponse(BaseModel):

src\core\config.py:9
  D:\coding\GIT_Work_Space\drug-analytics-api-python\src\core\config.py:9: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

tests/test_drug_service.py::TestDrugService::test_upload_drug_data_success
  D:\coding\GIT_Work_Space\drug-analytics-api-python\src\services\drug_service.py:63: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    created_at=datetime.utcnow()

tests/test_drug_service.py::TestDrugService::test_process_csv_and_save_success
tests/test_drug_service.py::TestDrugService::test_process_csv_and_save_multiple_records
tests/test_drug_service.py::TestDrugService::test_process_csv_and_save_multiple_records
tests/test_drug_service.py::TestDrugService::test_process_csv_and_save_multiple_records
  D:\coding\GIT_Work_Space\drug-analytics-api-python\src\models\drug_model.py:23: DeprecationWarning: datetime.datetime.utcnow() is deprecated and scheduled for removal in a future version. Use timezone-aware objects to represent datetimes in UTC: datetime.datetime.now(datetime.UTC).
    self.upload_timestamp = upload_timestamp or datetime.utcnow()

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
======================================================== short test summary info ========================================================= 
FAILED tests/test_drug_service.py::TestDrugService::test_upload_drug_data_success - src.core.exceptions.DynamoDBException: Unexpected error creating upload status: Parameter validation failed:
================================================ 1 failed, 6 passed, 7 warnings in 0.77s ================================================= 
PS D:\coding\GIT_Work_Space\drug-analytics-api-python> 